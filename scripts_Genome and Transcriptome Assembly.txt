
## All scripts used in the genome assembly course ###
# Melina DÃ¤ndliker

### An-1 ###

################################################################################################################################################################

### Quality control ###
 
#!/usr/bin/env bash                                                            
#SBATCH --cpus-per-task=1                                                  
#SBATCH --mem-per-cpu=4000M 
#SBATCH --time=01:30:00                                                                                                                      


module add UHTS/Quality_control/fastqc/0.11.9; 

                                                                                                                                                                                                                                                                                 
fastqc -o /data/users/mdaendliker/assembly_annotation_course/quality_control   /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/*.fastq.gz 
fastqc -o /data/users/mdaendliker/assembly_annotation_course/quality_control   /data/users/mdaendliker/assembly_annotation_course/participant_1/RNAseq/*.fastq.gz 
fastqc -o /data/users/mdaendliker/assembly_annotation_course/quality_control   /data/users/mdaendliker/assembly_annotation_course/participant_1/pacbio/*.fastq.gz 

#################################################################################################################################################################

### kmers ###

### kmers for An-1 Illumina ###

#!/usr/bin/env bash                        

#SBATCH --cpus-per-task=4     
#SBATCH --mem-per-cpu=40G                                                                  
#SBATCH --time=02:00:00                                                                                                                                                                                                                                                                                                                                                                                                                              


module add UHTS/Analysis/jellyfish/2.3.0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

jellyfish count \ 
-C -m 21 -s 5G -t 4  -o /data/users/mdaendliker/assembly_annotation_course/kmers/Illumina.jf <(zcat /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/*.fastq.gz)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
jellyfish histo -t 4 /data/users/mdaendliker/assembly_annotation_course/kmers/Illumina.jf > /data/users/mdaendliker/assembly_annotation_course/kmers/Illumina.histo  


### kmers for An-1 pacbio ###

#!/usr/bin/env bash                        

#SBATCH --cpus-per-task=4     
#SBATCH --mem-per-cpu=40G                                                                  
#SBATCH --time=02:00:00                                                                                                                                                                                                                                                                                                                                                                                                                              


module add UHTS/Analysis/jellyfish/2.3.0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

jellyfish count \ 
-C -m 21 -s 5G -t 4  -o /data/users/mdaendliker/assembly_annotation_course/kmers/pacbio.jf <(zcat /data/users/mdaendliker/assembly_annotation_course/participant_1/pacbio/*.fastq.gz)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
jellyfish histo -t 4 /data/users/mdaendliker/assembly_annotation_course/kmers/pacbio.jf > /data/users/mdaendliker/assembly_annotation_course/kmers/pacbio.histo   

#################################################################################################################################################################

### Assembly ###

### Flye ###
#!/usr/bin/env bash   
#SBATCH --cpus-per-task=16   
#SBATCH --mem-per-cpu=4G   
#SBATCH --time=1-00:00:00   

module add UHTS/Assembler/flye/2.8.3;  


flye --pacbio-raw /data/users/mdaendliker/assembly_annotation_course/participant_1/pacbio/*.fastq.gz -o /data/users/mdaendliker/assembly_annotation_course/assembly  -t 16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

### Canu ###

#!/usr/bin/env bash

#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=4G
#SBATCH --time=01:00:00


module add UHTS/Assembler/canu/2.1.1;


canu \
 -p pacbio_canu -d /data/users/mdaendliker/assembly_annotation_course/assembly/canu \
 genomeSize=135m \
 -pacbio /data/users/mdaendliker/assembly_annotation_course/participant_1/pacbio/*.fastq.gz \
gridEngineResourceOption="--cpus-per-task=THREADS --mem-per-cpu=MEMORY --time=1-00:00:00" gridOptions="--partion=pall" 


### Trinity ###

#!/usr/bin/env bash

#SBATCH --time=1-00:00:00
#SBATCH --mem=40G
#SBATCH --cpus-per-task=12


module add UHTS/Assembler/trinityrnaseq/2.5.1;


Trinity --seqType fq --left /data/users/mdaendliker/assembly_annotation_course/participant_1/RNAseq/ERR754061_1.fastq.gz \
--right /data/users/mdaendliker/assembly_annotation_course/participant_1/RNAseq/ERR754061_2.fastq.gz --output /data/users/mdaendliker/assembly_annotation_course/assembly/Trinity \
--CPU 12 --max_memory 40G 




#################################################################################################################################################################

### Polishing ###

### bowtie and sam to bam file convertion ###

### flye ###


#!/usr/bin/env bash        
#SBATCH --cpus-per-task=12 
#SBATCH --mem-per-cpu=20G    
#SBATCH --time=08:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

module add UHTS/Aligner/bowtie2/2.3.4.1;                                                                                                                                                                                                                                                                                        
module add UHTS/Analysis/samtools/1.10;             

bowtie2-build  /data/users/mdaendliker/assembly_annotation_course/assembly/assembly.fasta  /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
bowtie2 --sensitive-local -x /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie -1 /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_1.fastq.gz \
-2 /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_2.fastq.gz -S /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.sam                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

samtools view -bS /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.sam > /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.bam                                                                                                                                                     
samtools sort /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.bam -o /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.sorted.bam                                                                                                                                                                                                                                                                                                                                                        
samtools index /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.sorted.bam


### canu ###

#!/usr/bin/env bash        
#SBATCH --cpus-per-task=12    
#SBATCH --mem-per-cpu=20G      
#SBATCH --time=08:00:00    

module add UHTS/Aligner/bowtie2/2.3.4.1;  
module add UHTS/Analysis/samtools/1.10;     

bowtie2-build  /data/users/mdaendliker/assembly_annotation_course/assembly/canu/pacbio_canu.contigs.fasta   /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie          
bowtie2 --sensitive-local -x /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie  -1 /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_1.fastq.gz \    
-2 /data/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_2.fastq.gz  -S /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.sam                


samtools view -bS /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.sam > /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.bam     
samtools sort /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.bam -o /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.sorted.bam          
samtools index /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.sorted.bam 


                                                                                                                                                                                                                                                                                                                                                              
### polishing with pilon ###

### flye ###

#!/usr/bin/env bash       
#SBATCH --cpus-per-task=4 
#SBATCH --mem-per-cpu=40G  
#SBATCH --time=04:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

module add UHTS/Analysis/pilon/1.22;          

java -Xmx45g -jar /mnt/software/UHTS/Analysis/pilon/1.22/bin/pilon-1.22.jar       

pilon --genome /data/users/mdaendliker/assembly_annotation_course/assembly/assembly.fasta \                                                                               
 --bam /data/users/mdaendliker/assembly_annotation_course/assembly/flye_bowtie.sorted.bam --outdir /data/users/mdaendliker/assembly_annotation_course/assembly                     


### canu ###

#!/usr/bin/env bash       
#SBATCH --cpus-per-task=4 
#SBATCH --mem-per-cpu=40G  
#SBATCH --time=04:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

module add UHTS/Analysis/pilon/1.22;          

java -Xmx45g -jar /mnt/software/UHTS/Analysis/pilon/1.22/bin/pilon-1.22.jar       

pilon --genome /data/users/mdaendliker/assembly_annotation_course/assembly/canu/pacbio_canu.contigs.fasta  \         
--frags /data/users/mdaendliker/assembly_annotation_course/assembly/canu/canu_bowtie.sorted.bam \   
--outdir /data/users/mdaendliker/assembly_annotation_course/assembly/canu   

#################################################################################################################################################################

### quality control of the assemblies ###

### busco ###
#################################################################################################################################################################

### unpolished ###

### flye ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/busco   

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly.fasta  -o busco_flye  -l brassicales_odb10                                                                                                                                                                                                                                            

### canu ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/busco   

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/canu/pacbio_canu.contigs.fasta  -o busco_canu  -l brassicales_odb10 


### trinity ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/busco   

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m transcriptome -i /data/users/mdaendliker/assembly_annotation_course/assembly/Trinity/Trinity.fasta -o busco_trinity -l brassicales_odb10

#################################################################################################################################################################

### busco polished flye and canu ###

#!/usr/bin/env bash 
#SBATCH --time=08:00:00   
#SBATCH --mem-per-cpu=20G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 

PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/busco 

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/pilon.fasta  -o busco_flye_polished  -l brassicales_odb10                                                                                                                                                                                                                                            

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/canu/#pacbio_canu.contigs.fasta# -o busco_canu_polished  -l brassicales_odb10 


#################################################################################################################################################################

### Quast ### 

#!/usr/bin/env bash    
#SBATCH --time=06:00:00   
#SBATCH --mem-per-cpu=4G      
#SBATCH --cpus-per-task=4     
#SBATCH --job-name=quast       

module add UHTS/Quality_control/quast/4.6.0;    

quast.py /data/users/mdaendliker/assembly_annotation_course/assembly/assembly.fasta \  
/data/users/mdaendliker/assembly_annotation_course/assembly/canu/pacbio_canu.contigs.fasta \ 
data/users/mdaendliker/assembly_annotation_course/assembly/pilon.fasta \ 
/data/users/mdaendliker/assembly_annotation_course/assembly/canu/pilon/pilon.fasta \ 
-R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz \    
-G /data/courses/assembly-annotation-course/references/TAIR10_GFF3_genes.gff \        
--eukaryote --est-ref-size 135000000 --threads 1 --labels flye,canu,flyePolished,canuPolished --no-sv \   
-o /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/quast      

#################################################################################################################################################################

### mercury ####

### general preparation ###

### get ideal kmer size ###

#!/usr/bin/env bash  
#SBATCH --time=00:05:00     
#SBATCH --mem-per-cpu=4G     
#SBATCH --cpus-per-task=1        
#SBATCH --job-name=merqury     

cd /data/users/mdaendliker/users/mdaendliker/assembly_annotation_course/skripts            
PROJDIR=/data       
singularity exec \   
--bind $PROJDIR \    
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif best_k.sh 135000000  


### create the merlys ###

#!/usr/bin/env bash

#SBATCH --time= 1-00:00:00
#SBATCH --mem-per-cpu=4G
#SBATCH --cpus-per-task=4
#SBATCH --job-name=merqury


PROJDIR=/data   
singularity exec \     
--bind $PROJDIR \ 
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \ 
meryl k=18 count $PROJDIR/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_1.fastq.gz \
 output  $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579_1.meryl     


PROJDIR=/data   
singularity exec \     
--bind $PROJDIR \ 
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \ 
meryl k=18 count $PROJDIR/users/mdaendliker/assembly_annotation_course/participant_1/Illumina/ERR3624579_2.fastq.gz \
 output  $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579_2.meryl  


#!/usr/bin/env bash

#SBATCH --time=1-00:00:00
#SBATCH --mem-per-cpu=4G
#SBATCH --cpus-per-task=4
#SBATCH --job-name=merqury

PROJDIR=/data
singularity exec \
--bind $PROJDIR \
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \
meryl union-sum output $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579.meryl \ 
$PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/*.meryl 

#################################################################################################################################################################

### polished and unpolished Mercury###


#!/usr/bin/env bash 

#SBATCH --time=1-00:00:00     
#SBATCH --mem-per-cpu=4G        
#SBATCH --cpus-per-task=4       
#SBATCH --job-name=merqury          

PROJDIR=/data    
cd mercury_flye         

singularity exec \  
--bind $PROJDIR \         
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \                  
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579.meryl \          
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/assembly.fasta mercury_flye           

PROJDIR=/data                   
cd ..        
cd mercury_canu            
singularity exec \   
--bind $PROJDIR \   
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \   
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579.meryl \  
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/canu/pacbio_canu.contigs.fasta mercury_canu       

PROJDIR=/data    
cd ..          
cd mercury_flye_polished        
singularity exec \        
--bind $PROJDIR \   
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \         
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579.meryl \           
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/pilon.fasta mercury_flye_polished          

PROJDIR=/data       
cd ..      
cd mercury_canu_polished        
singularity exec \   
--bind $PROJDIR \              
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \      
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/mercury/ERR3624579.meryl \              
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/canu/pilon.fasta mercury_canu_polished                                                                                                                                                                                                                             


#################################################################################################################################################################



### Sha ###

#################################################################################################################################################################

# Quality control 


#!/usr/bin/env bash          
#SBATCH --cpus-per-task=1         
#SBATCH --mem-per-cpu=4000M     
#SBATCH --time=01:30:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     module add UHTS/Quality_control/fastqc/0.11.9;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
fastqc -o /data/users/mdaendliker/assembly_annotation_course/quality_control/quality_Sha    /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/*.fastq.gz    
fastqc -o /data/users/mdaendliker/assembly_annotation_course/quality_control/quality_Sha    /data/users/mdaendliker/assembly_annotation_course/participant_3/RNAseq/*.fastq.gz                                                                                                                                                                                                                                                                                                                                                                                                                                                     

#################################################################################################################################################################

# pacbio of Sha was run separatly becuase it caused some problmes
# the problmes could not be fixed so some calculations with bash and python are made 

grep -c -e "@ERR" ERR3415830.fastq
grep "@ERR" ERR3415830.fastq > ERR30.txt  
awk '{print($3)}' ERR30.txt > ERR30_new.txt


grep -c -e "@ERR" ERR3415831.fastq
grep "@ERR" ERR3415831.fastq > ERR31.txt  
awk '{print($3)}' ERR31.txt > ERR31_new.txt


### python ###

with open('ERR30_new.txt') as f:
    err30 = f.read()

length_list = []
err30 =err30.split('\n')
for i in err30:
    new = i.split('=')
    try:
        length_list.append(int(new[1]))
    except:
        break

print(max(length_list))
print(min(length_list))



with open('ERR31_new.txt') as f:
    err31 = f.read()

length_list = []
err31 =err31.split('\n')
for i in err31:
    new = i.split('=')
    try:
        length_list.append(int(new[1]))
    except:
        break

print(max(length_list))
print(min(length_list))



#################################################################################################################################################################

### kmers ###

### kmers for Sha Illumina ###

#!/usr/bin/env bash                        

#SBATCH --cpus-per-task=4     
#SBATCH --mem-per-cpu=40G                                                                  
#SBATCH --time=02:00:00                                                                                                                                                                                                                                                                                                                                                                                                                              


module add UHTS/Analysis/jellyfish/2.3.0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

jellyfish count \ 
-C -m 21 -s 5G -t 4  -o /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/Illumina_Sha.jf <(zcat /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/*.fastq.gz)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
jellyfish histo -t 4 /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/Illumina_Sha.jf > /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/Illumina_Sha.histo  


### kmers for An-1 pacbio ###

#!/usr/bin/env bash                        

#SBATCH --cpus-per-task=4     
#SBATCH --mem-per-cpu=40G                                                                  
#SBATCH --time=02:00:00                                                                                                                                                                                                                                                                                                                                                                                                                              


module add UHTS/Analysis/jellyfish/2.3.0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

jellyfish count \ 
-C -m 21 -s 5G -t 4  -o /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/pacbio_Sha.jf <(zcat /data/users/mdaendliker/assembly_annotation_course/participant_3/pacbio/*.fastq.gz)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
jellyfish histo -t 4 /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/pacbio_Sha.jf > /data/users/mdaendliker/assembly_annotation_course/kmers/kmers_Sha/pacbio_Sha.histo   

#################################################################################################################################################################

### Assembly ###

### Flye ###

#!/usr/bin/env bash   
#SBATCH --cpus-per-task=16   
#SBATCH --mem-per-cpu=4G   
#SBATCH --time=1-00:00:00   

module add UHTS/Assembler/flye/2.8.3;  


flye --pacbio-raw /data/users/mdaendliker/assembly_annotation_course/participant_3/pacbio/*.fastq.gz -o /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye  -t 16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
### Canu ###

#!/usr/bin/env bash
 
#BATCH --cpus-per-task=1  
#SBATCH --mem-per-cpu=4G  
#SBATCH --time=01:00:00   

module add UHTS/Assembler/canu/2.1.1;     

canu \  
-p pacbio_canu -d /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu \       
genomeSize=135m \ 
-pacbio /data/users/mdaendliker/assembly_annotation_course/participant_3/pacbio/*.fastq.gz \  
gridEngineResourceOption="--cpus-per-task=THREADS --mem-per-cpu=MEMORY --time=1-00:00:00" gridOptions="--partition=pall"                                                                                                                                                                                                                                                                                                                                   


### Trinity ###

#!/usr/bin/env bash         
#SBATCH --time=1-00:00:00          
#SBATCH --mem=40G    
#SBATCH --cpus-per-task=12       

module add UHTS/Assembler/trinityrnaseq/2.5.1;       

Trinity --seqType fq --left /data/users/mdaendliker/assembly_annotation_course/participant_3/RNAseq/ERR754081_1.fastq.gz \  
--right /data/users/mdaendliker/assembly_annotation_course/participant_3/RNAseq/ERR754081_2.fastq.gz \     
--output /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/Trinity --CPU 12 --max_memory 40G                                                                                                                                                        





#################################################################################################################################################################

### Polishing ###

### bowtie and sam to bam file convertion ###

### flye ###

#!/usr/bin/env bash        
#SBATCH --cpus-per-task=12 
#SBATCH --mem-per-cpu=20G    
#SBATCH --time=08:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

module add UHTS/Aligner/bowtie2/2.3.4.1;                                                                                                                                                                                                                                                                                        
module add UHTS/Analysis/samtools/1.10;             

bowtie2-build  /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/assembly.fasta  /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

bowtie2 --sensitive-local -x /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie  -1 /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_1.fastq.gz \
-2 /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_2.fastq.gz  -S /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.sam                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

samtools view -bS /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.sam > /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.bam                                                                                                                                                     
samtools sort /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.bam -o /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.sorted.bam                                                                                                                                                                                                                                                                                                                                                        
samtools index /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.sorted.bam  

### canu ###

#!/usr/bin/env bash        
#SBATCH --cpus-per-task=12 
#SBATCH --mem-per-cpu=20G    
#SBATCH --time=08:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

module add UHTS/Aligner/bowtie2/2.3.4.1;                                                                                                                                                                                                                                                                                        
module add UHTS/Analysis/samtools/1.10;             

bowtie2-build  /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pacbio_canu.contigs.fasta   /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

bowtie2 --sensitive-local -x /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie  -1 /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_1.fastq.gz \
-2 /data/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_2.fastq.gz  -S /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.sam                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

samtools view -bS /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.sam > /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.bam                                                                                                                                                     
samtools sort /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.bam -o /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.sorted.bam                                                                                                                                                                                                                                                                                                                                                        
samtools index /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.sorted.bam 

### pilon polishing ####

### flye and canu ###

#!/usr/bin/env bash       
#SBATCH --cpus-per-task=4 
#SBATCH --mem-per-cpu=40G  
#SBATCH --time=08:00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

module add UHTS/Analysis/pilon/1.22;          

java -Xmx45g -jar /mnt/software/UHTS/Analysis/pilon/1.22/bin/pilon-1.22.jar       

pilon --genome /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/assembly.fasta \                                                                               
 --bam /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/flye_Sha_bowtie.sorted.bam --outdir /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye                     

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
pilon --genome /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pacbio_canu.contigs.fasta  \                                                                               
 --bam /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/canu_Sha_bowtie.sorted.bam --outdir /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu           




#################################################################################################################################################################


### quality control of the assemblies ###

### unpolished ###

#################################################################################################################################################################
### busco ###

### flye ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/busco  

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/assembly.fasta  -o busco_flye  -l brassicales_odb10                                                                                                                                                                                                                                            

### canu ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/busco   

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pacbio_canu.contigs.fasta  -o busco_canu  -l brassicales_odb10 


### trinity ###

#!/usr/bin/env bash 
#SBATCH --time=02:00:00   
#SBATCH --mem-per-cpu=4G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 


PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/busco   

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m transcriptome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/Trinity/Trinity.fasta -o busco_trinity -l brassicales_odb10

#################################################################################################################################################################

### busco polished flye and canu ###

#!/usr/bin/env bash 
#SBATCH --time=08:00:00   
#SBATCH --mem-per-cpu=20G    
#SBATCH --cpus-per-task=4 
#SBATCH --job-name=busco 

PROJDIR=/data/users/mdaendliker/assembly_annotation_course      
cd /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/busco 

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/pilon.fasta  -o busco_flye_polished  -l brassicales_odb10                                                                                                                                                                                                                                            

singularity exec \  
--bind $PROJDIR \  
/data/courses/assembly-annotation-course/containers2/busco_v5.1.2_cv1.sif \ 
busco --cpu 4 -m genome -i /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pilon.fasta  -o busco_canu_polished  -l brassicales_odb10 


#################################################################################################################################################################

### Quast ### 

#################################################################################################################################################################

### unpolished ###

### flye  and canu ###

#!/usr/bin/env bash   

#SBATCH --time=06:00:00       
#SBATCH --mem-per-cpu=4G        
#SBATCH --cpus-per-task=4     
#SBATCH --job-name=quast               

module add UHTS/Quality_control/quast/4.6.0;                                      

quast.py /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/assembly.fasta \                          
/data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pacbio_canu.contigs.fasta \   
/data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/pilon.fasta \  
/data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pilon.fasta \       
-R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz \   
-G /data/courses/assembly-annotation-course/references/TAIR10_GFF3_genes.gff \           
--eukaryote --est-ref-size 135000000 --threads 1 --labels flye,canu,flyePolished,canuPolished --no-sv \     
-o /data/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/quast                                                                                                                                                                                                                                                                                                                      ~                                                                                              


#################################################################################################################################################################

### mercury ####

### genral preparation ####

#!/usr/bin/env bash

#SBATCH --time=1-00:00:00
#SBATCH --mem-per-cpu=4G
#SBATCH --cpus-per-task=4
#SBATCH --job-name=merqury


PROJDIR=/data   
singularity exec \     
--bind $PROJDIR \ 
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \ 
meryl k=18 count $PROJDIR/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_1.fastq.gz
 output  $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575_1.meryl     


PROJDIR=/data   
singularity exec \     
--bind $PROJDIR \ 
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \ 
meryl k=18 count $PROJDIR/users/mdaendliker/assembly_annotation_course/participant_3/Illumina/ERR3624575_2.fastq.gz \
 output  $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575_2.gz.meryl  


#!/usr/bin/env bash

#SBATCH --time=1-00:00:00
#SBATCH --mem-per-cpu=4G
#SBATCH --cpus-per-task=4
#SBATCH --job-name=merqury

PROJDIR=/data
singularity exec \
--bind $PROJDIR \
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif
meryl union-sum output $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575.meryl \ 
$PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/*.meryl 



#################################################################################################################################################################

### unpolished and unpolished###

#!/usr/bin/env bash  

#SBATCH --time=1-00:00:00           
#SBATCH --mem-per-cpu=4G        
#SBATCH --cpus-per-task=4   
#SBATCH --job-name=merqury         

PROJDIR=/data         
cd mercury_flye_Sha           
singularity exec \          
--bind $PROJDIR \   
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \      
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575.meryl \            
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/assembly.fasta mercury_flye_Sha      

PROJDIR=/data     
cd ..         
cd mercury_canu_Sha  
singularity exec \  
--bind $PROJDIR \     
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \       
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575.meryl \  
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pacbio_canu.contigs.fasta mercury_canu_Sha     

PROJDIR=/data     
cd ..         
cd mercury_flye_polished_Sha   
singularity exec \               
--bind $PROJDIR \     
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \      
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575.meryl \        
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/pilon.fasta mercury_flye_polished_Sha       

PROJDIR=/data      
cd ..      
cd mercury_canu_polished_Sha    
singularity exec \      
--bind $PROJDIR \      
/software/singularity/containers/Merqury-1.3-1.ubuntu20.sif \       
merqury.sh $PROJDIR/users/mdaendliker/assembly_annotation_course/quality_control_assembly/Sha/mercury/ERR3624575.meryl \        
$PROJDIR/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pilon.fasta mercury_canu_polished_Sha                                                                                                                                                                                                                                                                                                                          ~                                                                                                                                                                                                                                                                                                                         ~                                                                                                     

#################################################################################################################################################################
#################################################################################################################################################################

### Mummer for An-1 and Sha ###


#!/usr/bin/env bash     

#SBATCH --time=04:00:00     
#SBATCH --mem-per-cpu=20G        
#SBATCH --cpus-per-task=4   

cd /data/users/mdaendliker/assembly_annotation_course/nucmer           

module add UHTS/Analysis/mummer/4.0.0beta1    
nucmer --mincluster=1000 --breaklen=1000 --prefix=flye_An1 /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \      
/data/users/mdaendliker/assembly_annotation_course/assembly/pilon.fasta    

nucmer --mincluster=1000 --breaklen=1000 --prefix=canu_An1 /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \   
/data/users/mdaendliker/assembly_annotation_course/assembly/canu/pilon/pilon.fasta     

nucmer  --mincluster=1000 --breaklen=1000 --prefix=flye_Sha /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \   
/data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/pilon.fasta     

nucmer  --mincluster=1000 --breaklen=1000 --prefix=canu_Sha /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \   
/data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pilon.fasta                                                                                                                                                                                                                                 ~                                                                                                                                                                                                                                                                                                                         ~                                                                                             


#################################################################################################################################################################

#!/usr/bin/env bash  

#SBATCH --time=04:00:00 
#SBATCH --mem-per-cpu=20G   
#SBATCH --cpus-per-task=1      

module add UHTS/Analysis/mummer/4.0.0beta1   

cd /data/users/mdaendliker/assembly_annotation_course/nucmer/flye_An1    
mummerplot --png --large --layout --filter --fat -R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
-Q /data/users/mdaendliker/assembly_annotation_course/assembly/pilon.fasta \  
/data/users/mdaendliker/assembly_annotation_course/nucmer/flye_An1.delta      


cd /data/users/mdaendliker/assembly_annotation_course/nucmer/canu_An1   
mummerplot  --png --large --layout --filter --fat -R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \  
-Q /data/users/mdaendliker/assembly_annotation_course/assembly/canu/pilon.fasta \  
/data/users/mdaendliker/assembly_annotation_course/nucmer/canu_An1.delta    

cd /data/users/mdaendliker/assembly_annotation_course/nucmer/flye_Sha   
mummerplot --png --large --layout --filter --fat -R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \ 
-Q /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/flye/pilon.fasta \    
/data/users/mdaendliker/assembly_annotation_course/nucmer/flye_Sha.delta     

cd /data/users/mdaendliker/assembly_annotation_course/nucmer/canu_Sha  
mummerplot --png --large --layout --filter --fat -R /data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \  
-Q /data/users/mdaendliker/assembly_annotation_course/assembly/assembly_Sha/canu/pilon.fasta \               
/data/users/mdaendliker/assembly_annotation_course/nucmer/canu_Sha.delta                                                                                                                                                                                                                                                                                                                                                      ~                                                                                                                                                                                                                                                                                                                         ~                                                                              

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   